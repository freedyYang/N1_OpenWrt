name: Build img for N1

on:
  repository_dispatch:
  workflow_dispatch:
 
     
env:
  UPLOAD_COWTRANSFER: true
  UPLOAD_WETRANSFER: true
  RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04
    name: Build for N1
    strategy:
      fail-fast: false
    

 
    steps:
    - name: Checkout
      uses: actions/checkout@main
      
    - name: Initialization environment
      run: |     
        version=$(curl -s "https://api.github.com/repos/freedyYang/N1_OpenWrt/releases/latest" | awk -F '"' '/tag_name/{print $4}')
        
        echo "version=$version"  >> $GITHUB_ENV
        echo "DATE=$(date "+%Y-%m-%d %H:%M:%S")"  >> $GITHUB_ENV
        
        echo "version=$version"
        ls 
        pwd
        mkdir freedy
        sudo chmod  -R 777 freedy
        ls
        #cp -r ${FLIPPY_NAME}/opt/* /opt
                
    - name: Download
      run: |
        cd freedy
        tag='ARMv8_ROOTFS'
        
        wget  https://github.com/freedyYang/N1_OpenWrt/releases/download/$tag/openwrt-armvirt-64-default-rootfs.tar.gz
                
    - name: Check Files
      run: |
        cd freedy
        ls
                

    
    - name: Package Armvirt as OpenWrt
      id: package
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: freedy/openwrt-armvirt-64-default-rootfs.tar.gz   
        PACKAGE_SOC: s905d
        GZIP_IMGS: '.7z'
        SELECT_PACKITPATH: 'freedy'
        KERNEL_VERSION_NAME: 5.4.180 
        #KERNEL_VERSION_NAME: 5.16.10_5.15.24_5.10.101_5.4.180 
        
    - name: set firmware img 7z
      run: |       
        FIRMWARE=${{ env.PACKAGED_OUTPUTPATH }}/*.7z
        
    - name: Upload firmware to WeTransfer
      id: wetransfer
      if:  env.PACKAGED_STATUS == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh        
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"
  
    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: env.PACKAGED_STATUS == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
  
  
    - name: Create release
      id: release
      uses: ncipollo/release-action@v1
      with:
        tag: OpenWrt_N1-${{ env.PACKAGED_OUTPUTDATE }}
        artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
        allowUpdates: true        
        token: ${{ secrets.RELEASES_TOKEN }}  
        body: |
          ## ä»¥ä¸‹ä¸ºN1æœ€æ–°å›ºä»¶
          é»˜è®¤IPï¼š10.0.0.110 é»˜è®¤å¯†ç ï¼š password
          OpenwrtğŸš€(æ³¨:æ­¤ç‰ˆæœ¬ä¸ºä¸ªäººçš„ç²¾ç®€ç‰ˆã€‚+oç‰ˆå†…æ ¸æ›´ç¨³å®š)
          N1å…¨æ–°å®‰è£…æ–¹æ³•ï¼š
             1. cd root
             2. ./install-to-emmc.sh
          N1åœ¨çº¿å‡çº§æ–¹æ³•ï¼š
             1. cd /mnt/mmcblk2p4
             2. wget å‡çº§è„šæœ¬é“¾æ¥,é¼ æ ‡å³å‡»openwrt-update-amlogic
             3. wget img.gzåç¼€åçš„å›ºä»¶é“¾æ¥,é¼ æ ‡å³å‡»åç¼€.img.gz
             4. gzip -d è§£å‹ç¼©ä¸Šä¸€æ­¥ä¸‹è½½çš„å›ºä»¶å…¨å
             5. chmod +x openwrt-update-amlogic
             6. ./openwrt-update-amlogicåï¼Œé€‰æ‹©yæ˜¯ä¿ç•™é…ç½®å‡çº§ï¼Œé€‰Nç›¸å½“äºé‡è£…ã€‚
             7.å‡çº§å®Œæˆåç³»ç»Ÿä¼šè‡ªåŠ¨é‡å¯ï¼Œç¨å®‰å‹¿èºã€‚
       
   
    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.0
      with:
        keep_latest: 2
        delete_tags: true
        delete_tag_pattern: 'OpenWrt_N1-'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  
  
